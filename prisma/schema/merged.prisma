// This is your main Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}



// ========================================
// MERGED SCHEMA FILES
// ========================================

// ========================================
// FROM: admin.prisma
// ========================================

model PlatformStats {
  id                    String   @id @default(uuid())
  date                  DateTime @unique @db.Date
  
  // User Metrics
  totalUsers            Int      @default(0)
  newUsers              Int      @default(0)
  activeUsers           Int      @default(0) // Users who had at least 1 session
  peakConcurrentUsers   Int      @default(0)
  
  // Session Metrics
  totalSessions         Int      @default(0)
  completedSessions     Int      @default(0)
  abandonedSessions     Int      @default(0)
  avgSessionDuration    Float    @default(0) // in minutes
  totalStudyTime        Float    @default(0) // in hours
  
  // Room Metrics
  totalRoomJoins        Int      @default(0)
  failedJoins           Int      @default(0) // Due to capacity
  avgRoomOccupancy      Float    @default(0)
  peakRoomOccupancy     Int      @default(0)
  
  // Engagement Metrics
  totalMessages         Int      @default(0)
  cameraOnRate          Float    @default(0) // Percentage
  micOnRate             Float    @default(0) // Percentage
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  @@index([date])
  @@map("platform_stats")
}


model RoomAnalytics {
  id                    String   @id @default(uuid())
  roomId                String   @map("room_id")
  date                  DateTime @db.Date
  
  // Occupancy Metrics
  totalJoins            Int      @default(0)
  totalLeaves           Int      @default(0)
  failedJoins           Int      @default(0) // Capacity limit reached
  peakOccupancy         Int      @default(0)
  avgOccupancy          Float    @default(0)
  timeAtCapacity        Int      @default(0) // Minutes spent at 50 users
  
  // Session Quality
  avgTimePerUser        Float    @default(0) // in minutes
  totalSessionTime      Float    @default(0) // in hours
  
  // Interaction Metrics
  totalMessages         Int      @default(0)
  avgMessagesPerUser    Float    @default(0)
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  room                  Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@unique([roomId, date])
  @@index([roomId, date])
  @@index([date])
  @@map("room_analytics")
}


model RoomState {
  id                    String   @id @default(uuid())
  roomId                String   @unique @map("room_id")
  
  // Current State
  currentOccupancy      Int      @default(0)
  activeUsers           Json     @default("[]") // Array of user IDs currently in room
  
  // Timer State
  timerActive           Boolean  @default(false)
  timerStartedAt        DateTime?
  timerDuration         Int?     // in seconds
  timerPausedAt         DateTime?
  
  // Activity Counters (reset daily)
  messagesLast24h       Int      @default(0)
  joinsLast24h          Int      @default(0)
  
  lastActivityAt        DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  room                  Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@index([roomId])
  @@map("room_states")
}


model UserPresence {
  id                    String            @id @default(uuid())
  userId                Int               @map("user_id")
  roomId                String            @map("room_id")
  
  // Join Info
  joinedAt              DateTime          @default(now())
  socketId              String?           // For socket tracking
  
  // Media State
  cameraOn              Boolean           @default(false)
  micOn                 Boolean           @default(false)
  
  // Activity
  lastActivityAt        DateTime          @default(now())
  
  user                  User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  room                  Room              @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roomId])
  @@index([roomId])
  @@index([userId])
  @@index([joinedAt])
  @@map("user_presence")
}


model CapacityEvent {
  id                    String   @id @default(uuid())
  roomId                String   @map("room_id")
  eventType             CapacityEventType
  
  // Event Details
  occupancyAtEvent      Int      // How many users when event occurred
  timestamp             DateTime @default(now())
  duration              Int?     // For CAPACITY_FULL events, how long it lasted (seconds)
  
  room                  Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@index([roomId, timestamp])
  @@index([eventType, timestamp])
  @@map("capacity_events")
}

enum CapacityEventType {
  CAPACITY_REACHED    // Room hit 50 users
  CAPACITY_RELEASED   // Room dropped below 50
  JOIN_REJECTED       // User couldn't join due to capacity
}





model ModerationAction {
  id                    String            @id @default(uuid())
  
  // Target Info
  targetUserId          Int               @map("target_user_id")
  roomId                String?           @map("room_id")
  
  // Action Details
  actionType            ModerationType
  reason                String?           @db.Text
  duration              Int?              // For temporary actions (minutes)
  
  // Actor Info
  performedBy           Int               @map("performed_by") // Admin user ID
  performedAt           DateTime          @default(now())
  
  // Status
  isActive              Boolean           @default(true)
  expiresAt             DateTime?
  revokedAt             DateTime?
  revokedBy             Int?              @map("revoked_by")
  
  targetUser            User              @relation("ModerationTarget", fields: [targetUserId], references: [id], onDelete: Cascade)
  room                  Room?             @relation(fields: [roomId], references: [id], onDelete: SetNull)
  admin                 User              @relation("ModerationPerformer", fields: [performedBy], references: [id])
  revoker               User?             @relation("ModerationRevoker", fields: [revokedBy], references: [id])
  
  @@index([targetUserId])
  @@index([roomId])
  @@index([performedBy])
  @@index([actionType, isActive])
  @@index([performedAt])
  @@map("moderation_actions")
}

enum ModerationType {
  MUTE                // Mute user in room
  KICK                // Remove from room
  BAN                 // Ban from platform
  WARN                // Warning only
  UNMUTE              // Remove mute
  UNBAN               // Remove ban
}





model AuditLog {
  id                    String      @id @default(uuid())
  
  // Actor
  userId                Int         @map("user_id")
  userRole              Role        // Role at time of action
  
  // Action Details
  action                AuditAction
  resource              String      // e.g., "room", "user", "session"
  resourceId            String?     @map("resource_id") // ID of affected resource
  
  // Context
  description           String      @db.Text
  metadata              Json?       // Additional context (old/new values, etc.)
  ipAddress             String?     @map("ip_address")
  userAgent             String?     @map("user_agent")
  
  // Timestamp
  timestamp             DateTime    @default(now())
  
  user                  User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, timestamp])
  @@index([action, timestamp])
  @@index([resource, resourceId])
  @@index([timestamp])
  @@map("audit_logs")
}

enum AuditAction {
  // Room Actions
  ROOM_CREATED
  ROOM_DELETED
  ROOM_LOCKED
  ROOM_UNLOCKED
  ROOM_TIMER_RESET
  ROOM_CHAT_CLEARED
  ROOM_FORCE_END
  ROOM_USERS_REMOVED
  
  // User Actions
  USER_MUTED
  USER_UNMUTED
  USER_KICKED
  USER_BANNED
  USER_UNBANNED
  USER_WARNED
  USER_ROLE_CHANGED
  
  // System Actions
  SETTINGS_CHANGED
  ANALYTICS_EXPORTED
  DATA_PURGED
  
  // Admin Actions
  ADMIN_LOGIN
  ADMIN_LOGOUT
}





model SystemMetrics {
  id                    String   @id @default(uuid())
  timestamp             DateTime @default(now())
  
  // Connection Metrics
  activeSocketConnections Int    @default(0)
  failedConnections     Int      @default(0)
  
  // Performance Metrics
  avgApiResponseTime    Float    @default(0) // milliseconds
  errorRate4xx          Float    @default(0) // percentage
  errorRate5xx          Float    @default(0) // percentage
  
  // Timer Metrics
  timerDesyncEvents     Int      @default(0)
  
  // Resource Usage (optional, can be populated by monitoring service)
  cpuUsage              Float?   // percentage
  memoryUsage           Float?   // percentage
  
  @@index([timestamp])
  @@map("system_metrics")
}

// ========================================
// FROM: auth.prisma
// ========================================

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    Int
  expiresAt DateTime
  createdAt DateTime @default(now())
  isRevoked Boolean  @default(false)
  deviceInfo String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refresh_tokens")
}

model UserSession {
  id         String   @id @default(uuid())
  userId     Int
  deviceInfo String?
  ipAddress  String?
  userAgent  String?
  lastActive DateTime @default(now())
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// ========================================
// FROM: public-rooms.prisma
// ========================================

model AnonymousUser {
  id            String   @id @default(uuid())
  hashedIp      String   @unique @map("hashed_ip")
  displayName   String   @map("display_name")
  createdAt     DateTime @default(now()) @map("created_at")
  lastActiveAt  DateTime @default(now()) @map("last_active_at")
  
  // Relations
  roomParticipations RoomParticipant[]
  chatMessages       ChatMessage[]
  
  @@index([hashedIp])
  @@index([lastActiveAt])
  @@map("anonymous_users")
}

model RoomParticipant {
  id              String   @id @default(uuid())
  roomId          String   @map("room_id")
  anonymousUserId String   @map("anonymous_user_id")
  joinedAt        DateTime @default(now()) @map("joined_at")
  isVideoEnabled  Boolean  @default(false) @map("is_video_enabled")
  isAudioEnabled  Boolean  @default(false) @map("is_audio_enabled")
  
  // Relations
  room          Room          @relation("PublicRoomParticipants", fields: [roomId], references: [id], onDelete: Cascade)
  anonymousUser AnonymousUser @relation(fields: [anonymousUserId], references: [id], onDelete: Cascade)
  
  @@unique([roomId, anonymousUserId])
  @@index([roomId])
  @@index([anonymousUserId])
  @@map("room_participants")
}

model ChatMessage {
  id              String   @id @default(uuid())
  roomId          String   @map("room_id")
  anonymousUserId String   @map("anonymous_user_id")
  content         String   @db.Text
  createdAt       DateTime @default(now()) @map("created_at")
  
  // Relations
  room          Room          @relation("PublicRoomChatMessages", fields: [roomId], references: [id], onDelete: Cascade)
  anonymousUser AnonymousUser @relation(fields: [anonymousUserId], references: [id], onDelete: Cascade)
  
  @@index([roomId, createdAt])
  @@index([anonymousUserId])
  @@map("chat_messages")
}

model RateLimitRecord {
  id          String   @id @default(uuid())
  hashedIp    String   @map("hashed_ip")
  action      String
  attempts    Int      @default(1)
  windowStart DateTime @default(now()) @map("window_start")
  blockedUntil DateTime? @map("blocked_until")
  
  @@unique([hashedIp, action])
  @@index([hashedIp])
  @@index([blockedUntil])
  @@map("rate_limit_records")
}

model SuspiciousActivityLog {
  id           String   @id @default(uuid())
  hashedIp     String   @map("hashed_ip")
  activityType String   @map("activity_type")
  details      String   @default("")
  timestamp    DateTime @default(now())
  
  @@index([hashedIp])
  @@index([timestamp])
  @@index([activityType])
  @@map("suspicious_activity_logs")
}

// ========================================
// FROM: room.prisma
// ========================================

model Room {
  id                String        @id @default(uuid())
  name              String        @unique
  capacity          Int           @default(50)
  currentOccupancy  Int           @default(0) @map("current_occupancy")
  isLocked          Boolean       @default(false) @map("is_locked") // Admin can lock room
  createdAt         DateTime      @default(now()) @map("created_at")
  
  participants      Participant[]
  messages          Message[]
  sessionLogs       SessionLog[]  @relation("RoomSessionLogs")
  
  // Admin & Analytics Relations
  analytics         RoomAnalytics[]
  state             RoomState?
  presences         UserPresence[]
  capacityEvents    CapacityEvent[]
  moderationActions ModerationAction[]
  
  // Public Study Rooms Relations
  publicParticipants RoomParticipant[] @relation("PublicRoomParticipants")
  chatMessages       ChatMessage[]     @relation("PublicRoomChatMessages")
  
  @@index([name])
  @@map("rooms")
}

model Participant {
  id        String            @id @default(uuid())
  userId    Int               @map("user_id")
  roomId    String            @map("room_id")
  joinedAt  DateTime          @default(now()) @map("joined_at")
  status    ParticipantStatus @default(ACTIVE)
  
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  room      Room              @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  @@unique([userId, roomId])
  @@index([roomId])
  @@index([userId])
  @@map("participants")
}

enum ParticipantStatus {
  ACTIVE
  MUTED
}

model Message {
  id        String      @id @default(uuid())
  roomId    String      @map("room_id")
  userId    Int         @map("user_id")
  content   String      @db.Text
  type      MessageType @default(TEXT)
  timestamp DateTime    @default(now())
  
  room      Room        @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([roomId, timestamp])
  @@index([userId])
  @@map("messages")
}

enum MessageType {
  TEXT
  EMOJI
  POLL
}

model SessionLog {
  id        String   @id @default(uuid())
  roomId    String   @map("room_id")
  userId    Int      @map("user_id")
  duration  Int      // in seconds
  createdAt DateTime @default(now()) @map("created_at")
  
  room      Room     @relation("RoomSessionLogs", fields: [roomId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([roomId])
  @@index([userId])
  @@index([createdAt])
  @@map("session_logs")
}

// ========================================
// FROM: study.prisma
// ========================================

model StudySession {
  id              String        @id @default(uuid())
  userId          Int
  
  // Session Configuration
  subject         String
  topic           String?
  sessionType     SessionType   @default(CUSTOM)
  plannedDuration Int           // Planned duration in minutes
  notes           String?
  deviceId        String?
  
  // Time Tracking (All times in UTC)
  startTime       DateTime
  endTime         DateTime?
  
  // Pause/Resume Tracking
  pausedAt        DateTime?
  totalPausedTime Int           @default(0) // Total paused time in seconds
  pauseCount      Int           @default(0) // Number of times paused
  
  // Session State
  status          SessionStatus @default(ACTIVE)
  
  // Analytics & Performance
  actualStudyTime Int?          // Actual focus time in minutes (excluding pauses)
  productivityScore Float?      // Calculated score (actual vs planned)
  
  // Metadata
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  pauseEvents     PauseEvent[]
  
  // Indexes for performance
  @@index([userId, status])
  @@index([userId, startTime])
  @@index([startTime])
  @@map("study_sessions")
}

model PauseEvent {
  id              String       @id @default(uuid())
  sessionId       String
  pausedAt        DateTime
  resumedAt       DateTime?
  pauseDuration   Int?         // Duration in seconds
  createdAt       DateTime     @default(now())
  
  session         StudySession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId])
  @@map("pause_events")
}

model Subject {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  color       String?  // Hex color for UI
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("subjects")
}

model StudyGoal {
  id              Int        @id @default(autoincrement())
  userId          Int
  title           String
  description     String?
  targetHours     Int        // Target hours per period
  targetPeriod    GoalPeriod @default(WEEKLY)
  isActive        Boolean    @default(true)
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("study_goals")
}


enum SessionType {
  POMODORO_25    // 25 minute Pomodoro
  POMODORO_50    // 50 minute Pomodoro
  CUSTOM         // Custom duration
  DEEP_WORK      // Deep work session (90+ minutes)
  REVIEW         // Review session
}

enum SessionStatus {
  ACTIVE         // Currently running
  PAUSED         // Temporarily paused
  COMPLETED      // Successfully completed
  ABANDONED      // Ended before completion
  EXPIRED        // Auto-expired due to timeout
}

enum GoalPeriod {
  DAILY
  WEEKLY
  MONTHLY
}

// ========================================
// FROM: user.prisma
// ========================================

model User {
  id                Int       @id @default(autoincrement())
  email             String    @unique
  firstName         String?
  lastName          String?
  password          String?   // Optional for social login users
  role              Role      @default(STUDENT)
  isEmailVerified   Boolean   @default(false)
  emailVerifyToken  String?
  passwordResetToken String?
  passwordResetExpires DateTime?
  googleId          String?   @unique
  profilePicture    String?
  lastLoginAt       DateTime?
  
  // User Preferences
  timezone          String?   @default("UTC")
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Authentication Relations
  refreshTokens     RefreshToken[]
  sessions          UserSession[]
  
  // Study Relations
  studySessions     StudySession[]
  studyGoals        StudyGoal[]
  
  // Room Relations
  participants      Participant[]
  messages          Message[]
  sessionLogs       SessionLog[]
  
  // Admin & Moderation Relations
  presences                      UserPresence[]
  moderationActionsTarget        ModerationAction[] @relation("ModerationTarget")
  moderationActionsPerformed     ModerationAction[] @relation("ModerationPerformer")
  moderationActionsRevoked       ModerationAction[] @relation("ModerationRevoker")
  auditLogs                      AuditLog[]

  @@map("users")
}

enum Role {
  STUDENT
  SUPER_ADMIN
}

